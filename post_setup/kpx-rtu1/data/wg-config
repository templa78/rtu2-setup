#!/bin/bash

set -euo pipefail

if [[ $# -eq 0 ]]; then
  echo "usage: wg-config <ifname>"
  exit 1
fi

IF="$1"
CONF="/etc/wireguard/${IF}.conf"
SOCK="/run/wireguard/${IF}.sock"

declare -A CFG

parse_conf() {
  local file="$1" line key val
  while IFS= read -r line || [[ -n "$line" ]]; do
    # 주석 제거 (# 또는 ;)  (라인 중간 주석도 제거)
    line="${line%%#*}"
    line="${line%%;*}"

    # 앞뒤 공백 제거
    line="${line#"${line%%[![:space:]]*}"}"
    line="${line%"${line##*[![:space:]]}"}"

    # 빈 줄/섹션 헤더 무시
    [[ -z "$line" ]] && continue
    [[ "$line" =~ ^\[[^]]+\]$ ]] && continue

    # KEY=VALUE 형태만 처리
    [[ "$line" != *"="* ]] && continue

    key="${line%%=*}"
    val="${line#*=}"

    # key/val 공백 제거
    key="${key%"${key##*[![:space:]]}"}"
    key="${key#"${key%%[![:space:]]*}"}"
    val="${val%"${val##*[![:space:]]}"}"
    val="${val#"${val%%[![:space:]]*}"}"

    [[ -n "$key" ]] && CFG["$key"]="$val"
  done < "$file"
}

b64tohex() {
  local b64="${1:-}"
  [[ -n "$b64" ]] || return 1
  printf '%s' "$b64" | base64 -d 2>/dev/null | hexdump -v -e '/1 "%02x"'
}

parse_conf "$CONF"

ADDR="${CFG[Address]:-}"
LPORT="${CFG[ListenPort]:51820}"
PRIV_B64="${CFG[PrivateKey]:-}"
PUB_B64="${CFG[PublicKey]:-}"
AIPS="${CFG[AllowedIPs]:-}"
EP="${CFG[Endpoint]:-}"
KA="${CFG[PersistentKeepalive]:25}"

# 필수값 검증
[[ -n "$ADDR" ]] || { echo "Missing Interface.Address in $CONF" >&2; exit 2; }
[[ -n "$PRIV_B64" ]] || { echo "Missing Interface.PrivateKey in $CONF" >&2; exit 2; }
[[ -n "$PUB_B64" ]] || { echo "Missing Peer.PublicKey in $CONF" >&2; exit 2; }
[[ -n "$AIPS" ]] || { echo "Missing Peer.AllowedIPs in $CONF" >&2; exit 2; }
[[ -n "$EP" ]] || { echo "Missing Peer.Endpoint in $CONF" >&2; exit 2; }

PRIV_HEX="$(b64tohex "$PRIV_B64")"
PUB_HEX="$(b64tohex "$PUB_B64")"

cat <<EOF | sh -c "nc -U -q 0 \"$SOCK\""
set=1
private_key=$PRIV_HEX
listen_port=$LPORT
replace_peers=true
public_key=$PUB_HEX
endpoint=$EP
persistent_keepalive_interval=$KA
replace_allowed_ips=true
allowed_ip=$AIPS

EOF

echo "====="
echo "ADDR = [$ADDR]"
echo "LPORT = [$LPORT]"
echo "PRIV_HEX = [$PRIV_HEX]"
echo "PUB_HEX = [$PUB_HEX]"
echo "END_PT = [$EP]"
echo "AIPS = [$AIPS]"
echo "KEEP_ALIVE = [$KA]"
echo "====="

ip link set "$IF" up
ip addr add "$ADDR" dev "$IF" 2>/dev/null || true
ip route add "$AIPS" dev "$IF" 2>/dev/null || true
